<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shropshire events</title>
  <meta name="description" content="Auto-updating calendar of events across Shropshire ‚Äî Shrewsbury first.">
  <link rel="canonical" href="https://JonnyUtah100pc.github.io/Shropshire-Events">
  <style>
    :root { --bg:#0b1020; --panel:#141d3d; --text:#ecf0ff; --muted:#a7b0d6; --accent:#7dd3fc; --accent2:#a78bfa; }
    * { box-sizing:border-box; }
    html,body { margin:0; padding:0; background:linear-gradient(180deg,#0b1020,#0f1533); color:var(--text);
                font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans", sans-serif; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width:1100px; margin:0 auto; padding:28px 18px 60px; }
    header { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:16px; }
    h1 { font-size:clamp(28px,3.2vw,40px); margin:0; }
    .tagline { color:var(--muted); margin-top:6px; }
    .actions { display:flex; gap:12px; flex-wrap:wrap; }
    .btn { display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px;
            background:linear-gradient(90deg,var(--accent2),var(--accent)); color:#0b1020; font-weight:700; border:1px solid rgba(255,255,255,.08); }
    .btn.secondary { background:#1a2150; color:var(--text); }
    .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:16px; margin-top:22px; }
    .card { background: radial-gradient(120% 140% at 0% 0%, #1b2550 0%, #141d3d 50%, #111735 100%);
             border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; }
    .card h3 { margin:0 0 8px 0; font-size:18px; }
    .meta { color:var(--muted); font-size:14px; margin-bottom:8px; }
    .footer { margin-top:34px; padding-top:14px; border-top:1px solid rgba(255,255,255,.12); color:var(--muted); font-size:14px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background: rgba(255,255,255,.08); font-size:12px; margin-left:6px; }
    .nowrap { white-space:nowrap; }
    #status { margin-top:14px; color:var(--muted); font-size:14px; }
  </style>
  <!-- ical.js from CDN for ICS parsing in-browser -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js" defer></script>
  <script defer>
    async function loadEvents() {
      const status = document.getElementById('status');
      const grid = document.getElementById('events-grid');
      try {
        const res = await fetch('shropshire-events.ics', { cache: 'no-store' });
        if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        const icsText = await res.text();
        const jcal = ICAL.parse(icsText);
        const comp = new ICAL.Component(jcal);
        const vevents = comp.getAllSubcomponents('vevent') || [];

        const now = new Date();
        const items = vevents.map(v => {
          const ev = new ICAL.Event(v);
          const s = ev.startDate ? ev.startDate.toJSDate() : null;
          const e = ev.endDate ? ev.endDate.toJSDate() : s;
          const loc = v.getFirstPropertyValue('location') || '';
          const url = v.getFirstPropertyValue('url') || '';
          const cats = v.getFirstPropertyValue('categories') || '';
          const priority = parseInt(v.getFirstPropertyValue('priority') || '5', 10);
          return {
            summary: ev.summary || 'Event',
            start: s, end: e, url, location: loc, cats, priority
          };
        }).filter(it => it.start && it.end && it.end >= now);

        // prioritise Shrewsbury events
        function isShrewsbury(it) {
          const t = (it.location + ' ' + it.summary + ' ' + (it.cats||'')).toLowerCase();
          return t.includes('shrewsbury');
        }
        items.sort((a,b) => {
          const sa = isShrewsbury(a), sb = isShrewsbury(b);
          if (sa !== sb) return sa ? -1 : 1;
          return a.start - b.start;
        });

        const limit = 60; // show next 60
        const fmt = new Intl.DateTimeFormat('en-GB', { day:'2-digit', month:'short', year:'numeric' });
        grid.innerHTML = '';
        items.slice(0, limit).forEach(it => {
          const dateStr = it.end && it.end > it.start
            ? fmt.format(it.start) + ' ‚Äì ' + fmt.format(new Date(it.end.getTime() - 86400000))
            : fmt.format(it.start);
          const aOpen = it.url ? `<a href="${it.url}" target="_blank" rel="noopener">` : '';
          const aClose = it.url ? `</a>` : '';
          const tag = isShrewsbury(it) ? '<span class="pill">Shrewsbury</span>' : '';
          const card = document.createElement('article');
          card.className = 'card';
          card.innerHTML = `
            <h3>${aOpen}${it.summary}${aClose} ${tag}</h3>
            <div class="meta">${dateStr} ‚Ä¢ <span class="nowrap">${it.location || ''}</span></div>
            <div>${it.url ? 'Check the official page for live updates.' : ''}</div>
          `;
          grid.appendChild(card);
        });

        status.textContent = items.length
          ? `Showing ${Math.min(items.length, limit)} of ${items.length} upcoming events`
          : 'No upcoming events found in the feed.';
      } catch (err) {
        console.error(err);
        status.innerHTML = 'Could not load events. Make sure <code>shropshire-events.ics</code> exists at the site root and that GitHub Pages is enabled.';
      }
    }
    window.addEventListener('DOMContentLoaded', () => {
      if (typeof ICAL === 'undefined') {
        // ical.js may still be loading; try after a brief delay
        setTimeout(loadEvents, 300);
      } else {
        loadEvents();
      }
    });
  </script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Shropshire events</h1>
        <div class="tagline">Auto-updating 2-year feed ‚Ä¢ Shrewsbury highlighted</div>
      </div>
      <div class="actions">
        <a class="btn" href="webcal://JonnyUtah100pc.github.io/Shropshire-Events/shropshire-events.ics" title="Subscribe in Apple/Outlook">üìÖ Subscribe</a>
        <a class="btn secondary" href="https://JonnyUtah100pc.github.io/Shropshire-Events/shropshire-events.ics" title="Download the ICS file">‚¨áÔ∏è Download ICS</a>
      </div>
    </header>

    <section>
      <h2 style="margin:20px 0 6px 0;">Upcoming events</h2>
      <div id="status">Loading‚Ä¶</div>
      <div id="events-grid" class="grid"></div>
    </section>

    <section class="footer">
      <p>Calendar feed URL: <a href="https://JonnyUtah100pc.github.io/Shropshire-Events/shropshire-events.ics">https://JonnyUtah100pc.github.io/Shropshire-Events/shropshire-events.ics</a> <span class="pill">.ics</span></p>
      <p>Tip: In Google Calendar, use <em>Settings &gt; Add calendar &gt; From URL</em> and paste the link above.</p>
    </section>
  </div>
</body>
</html>
